name: Deploy Pipeline

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: ${{ secrets.STAGING_URL }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Deploy to staging server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_SSH_USER }}@${{ secrets.STAGING_SSH_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.STAGING_DEPLOY_PATH }}
            git pull origin main
            docker-compose -f infra/docker/docker-compose.staging.yml pull
            docker-compose -f infra/docker/docker-compose.staging.yml up -d --no-deps --build
            docker-compose -f infra/docker/docker-compose.staging.yml ps
          EOF
      
      - name: Wait for health check
        run: |
          echo "Waiting for services to be healthy..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f ${{ secrets.STAGING_URL }}/health; then
              echo "Health check passed!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying in 5 seconds..."
            sleep 5
          done
          echo "Health check failed after $max_attempts attempts"
          exit 1
      
      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh ${{ secrets.STAGING_URL }}
      
      - name: Rollback on failure
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.STAGING_SSH_USER }}@${{ secrets.STAGING_SSH_HOST }} << 'EOF'
            set -e
            cd ${{ secrets.STAGING_DEPLOY_PATH }}
            echo "Rolling back to previous version..."
            docker-compose -f infra/docker/docker-compose.staging.yml down
            docker-compose -f infra/docker/docker-compose.staging.yml up -d
            echo "Rollback complete"
          EOF

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: ${{ secrets.PRODUCTION_URL }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(date +%Y%m%d-%H%M%S)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"
      
      - name: Deploy to production server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_SSH_USER }}@${{ secrets.PRODUCTION_SSH_HOST }} << EOF
            set -e
            cd ${{ secrets.PRODUCTION_DEPLOY_PATH }}
            export VERSION=${{ steps.version.outputs.version }}
            git pull origin main
            docker-compose -f infra/docker/docker-compose.prod.yml pull
            docker-compose -f infra/docker/docker-compose.prod.yml up -d --no-deps --build
            docker-compose -f infra/docker/docker-compose.prod.yml ps
          EOF
      
      - name: Wait for health check
        run: |
          echo "Waiting for services to be healthy..."
          max_attempts=30
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -f ${{ secrets.PRODUCTION_URL }}/health; then
              echo "Health check passed!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts failed, retrying in 5 seconds..."
            sleep 5
          done
          echo "Health check failed after $max_attempts attempts"
          exit 1
      
      - name: Run smoke tests
        run: |
          chmod +x scripts/smoke-tests.sh
          ./scripts/smoke-tests.sh ${{ secrets.PRODUCTION_URL }}
      
      - name: Rollback on failure
        if: failure()
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.PRODUCTION_SSH_USER }}@${{ secrets.PRODUCTION_SSH_HOST }} << EOF
            set -e
            cd ${{ secrets.PRODUCTION_DEPLOY_PATH }}
            echo "Rolling back to previous version..."
            docker-compose -f infra/docker/docker-compose.prod.yml down
            docker-compose -f infra/docker/docker-compose.prod.yml up -d
            echo "Rollback complete"
          EOF
      
      - name: Create deployment notification
        if: success()
        run: |
          echo "âœ… Production deployment successful!"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "URL: ${{ secrets.PRODUCTION_URL }}"
